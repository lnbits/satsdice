{% extends "public.html" %} {% block page %}

<q-card class="fixed-center q-pa-xl" style="width:600px">
    <q-card-section class="q-pa-none" v-if="activeGame">{% raw %}
        <center>
            <h3 class=" q-my-none q-mb-xl">{{ coinflip.name }}</h3>
        </center>
        <div class="row">
            <div class="col">
                <center>
                    <q-badge outline size="xl" color="secondary">
                        <div class="text-subtitle1">
                            No. of Players: {{coinflip.number_of_players}}
                        </div>
                    </q-badge>
                </center>
            </div>
            <div class="col">
                <center>
                    <q-badge outline size="xl" color="secondary">
                        <div class="text-subtitle1">
                            Buy In: {{coinflip.buy_in}} sats
                        </div>
                    </q-badge>
                </center>
            </div>
            <div class="col">
                <center>

                    <q-badge outline size="xl" color="secondary">
                        <div class="text-subtitle1">
                            House Cut: {{coinflipHaircut}} %
                        </div>
                    </q-badge>
                </center>
            </div>
        </div>{% endraw %}
        <q-form @submit="joinGame" class="q-gutter-md">
            <q-input label="Your LNadress" class="q-mt-lg" type="text" v-model="lnaddress" required></q-input>
            <q-btn outline class="q-mt-lg" type="submit">Join Coinflip</q-btn>
            <q-btn class="q-ml-lg q-mt-md" unelevated dense size="col-md-5" icon="link"
                :color="($q.dark.isActive) ? 'grey-7' : 'grey-5'" @click="copyText"><q-tooltip>Copy coinflip
                    link</q-tooltip></q-btn>
        </q-form>
    </q-card-section>
    <q-card-section class="q-pa-none" v-else>
        <h3 class=" q-my-none">Create Coinflip Game</h3>
        <q-form @submit="createGame" class="q-gutter-md">
            <q-input label="Name" type="text" v-model="coinflip.name" required></q-input>
            <q-input :label="'Number of players (max ' + coinflipMaxPlayers + ')'" type="number"
                v-model="coinflip.number_of_players" required></q-input>
            <q-input :label="'Buy in (max ' + coinflipMaxBet + 'sats)'" type="number"
                v-model="coinflip.buy_in"></q-input>
            <q-btn outline type="submit" class="q-mt-lg">Create Coinflip</q-btn>
        </q-form>
    </q-card-section>
</q-card>


{% endblock %} {% block scripts %}
<script>
    Vue.component(VueQrcode.name, VueQrcode)

    new Vue({
        el: '#vue',
        mixins: [windowMixin],
        data() {
            return {
                activeGame: false,
                gameId: "",
                coinflip: {
                    name: "",
                    number_of_players: 0,
                    buy_in: 0,
                },
                coinflipHaircut: parseInt('{{ coinflipHaircut }}'),
                coinflipMaxPlayers: parseInt('{{ coinflipMaxPlayers }}'),
                coinflipMaxBet: parseInt('{{ coinflipMaxBet }}'),
                coinflipPageId: '{{ coinflipPageId }}',
                lnaddress: "",
            }
        },
        methods: {
            getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search)
                return urlParams.get(param)
            },
            async getGame() {
                self = this
                const response = await LNbits.api.request(
                    'GET',
                    `/satsdice/api/v1/coinflip/${this.gameId}`,
                    ''
                )
                console.log(response.data)
                if (response.data) {
                    self.coinflip = response.data
                    self.activeGame = true
                }
            },
            async createGame() {
                self = this
                const data = {
                    name: self.coinflip.name,
                    number_of_players: parseInt(self.coinflip.number_of_players),
                    buy_in: parseInt(self.coinflip.buy_in),
                    page_id: self.coinflipPageId
                }
                console.log(data)
                if (data.buy_in > self.coinflipMaxBet) {
                    this.$q.notify({
                        type: 'negative',
                        message: `Max bet is ${this.coinflipMaxBet}`
                    })
                    return
                }
                if (this.coinflip.number_of_players > this.coinflipMaxPlayers) {
                    this.$q.notify({
                        type: 'negative',
                        message: `Max players is ${this.coinflipMaxPlayers}`
                    })
                    return
                }
                try {
                    const response = await LNbits.api.request(
                        'POST',
                        '/satsdice/api/v1/coinflip/',
                        '',
                        data
                    )
                    console.log(response.data)
                    if (response.data) {
                        console.log(response.data)
                        this.activeGame = true
                        window.history.replaceState(null, null, "?game=" + response.data)
                    }
                } catch (error) {
                    LNbits.utils.notifyApiError(error)
                }
            },
            async joinGame() {
                try {
                    const data = {
                        lnaddress: this.lnaddress
                    }

                    const response = await LNbits.api.request(
                        'POST',
                        '/satsdice/api/v1/coinflip/join/' + this.coinflipPageId,
                        '',
                        data
                    )
                    console.log(response.data)
                    if (response.data) {
                        console.log(response.data)
                        // this.coinflip = data
                    }
                } catch (error) {
                    LNbits.utils.notifyApiError(error)
                }
            },
            copyText: function (text, message) {
                var notify = this.$q.notify
                Quasar.utils.copyToClipboard(window.location.href).then(function () {
                    notify({
                        message: 'Copied coinflip link!',
                        position: 'bottom'
                    })
                })
            },
        },
        async mounted() {
            this.gameId = this.getQueryParam('game')
            if (this.gameId) {
                game = await this.getGame()
            }
        }
    })
</script>
{% endblock %}